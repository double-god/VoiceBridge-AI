# è½»é‡çº§çš„ python-slim
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ– (åŒ…å« CosyVoice ç¼–è¯‘éœ€è¦çš„å·¥å…·)
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    git \
    g++ \
    build-essential \
    && rm -rf /var/lib/apt/lists/*
    # æ¸…ç† apt ç¼“å­˜ï¼Œå‡å°é•œåƒä½“ç§¯

# å®‰è£… uv
# ç›´æ¥ä»å®˜æ–¹é•œåƒå¤åˆ¶ uv äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# ä½¿ç”¨ uv å®‰è£…ä¾èµ–
COPY requirements.txt .

# --system: ç›´æ¥è£…åœ¨ç³»ç»Ÿ python é‡Œï¼Œä¸åˆ›å»º venv
# --index-url: æŒ‡å®šé˜¿é‡Œäº‘æºåŠ é€Ÿ
# uv pip install: uv çš„ pip æ¥å£ï¼Œå®Œå…¨å…¼å®¹ pip è¯­æ³•
RUN uv pip install --system --no-cache -r requirements.txt --index-url https://mirrors.aliyun.com/pypi/simple/

# ğŸ”¥ CosyVoice ä¾èµ– (å»¶è¿Ÿå¯¼å…¥ï¼Œä¸ä¼šåœ¨å¯åŠ¨æ—¶æŠ¥é”™)
RUN uv pip install --system --no-cache \
    modelscope \
    torchaudio \
    addict \
    scipy \
    librosa \
    soundfile \
    'datasets<3.0.0' \
    transformers \
    Pillow \
    simplejson \
    sortedcontainers \
    oss2 \
    yapf \
    einops \
    timm \
    conformer==0.3.2 \
    HyperPyYAML==1.2.2 \
    inflect==7.3.1 \
    hydra-core==1.3.2 \
    omegaconf==2.3.0 \
    protobuf==4.25 \
    pyworld==0.3.4 \
    'onnxruntime>=1.23.0' \
    wetext==0.0.4 \
    --index-url https://mirrors.aliyun.com/pypi/simple/

# å…‹éš†å¹¶å®‰è£… CosyVoice
RUN git clone --depth 1 https://github.com/FunAudioLLM/CosyVoice.git /tmp/CosyVoice && \
    cp -r /tmp/CosyVoice/cosyvoice /usr/local/lib/python3.11/site-packages/ && \
    rm -rf /tmp/CosyVoice

# å®‰è£… Matcha-TTS å­æ¨¡å— (CosyVoice ä¾èµ–)
RUN git clone --depth 1 https://github.com/shivammehta25/Matcha-TTS.git /tmp/Matcha-TTS && \
# depth1 å…‹éš†åªæ‹¿æœ€æ–°æäº¤ï¼Œå‡å°é•œåƒä½“ç§¯
    cp -r /tmp/Matcha-TTS/matcha /usr/local/lib/python3.11/site-packages/ && \
    # ç›´æ¥æŠŠæºç ä¸¢åˆ° site-packages é‡Œï¼Œçœå»å®‰è£…æ­¥éª¤
    rm -rf /tmp/Matcha-TTS

# å®‰è£… Matcha-TTS å’Œ CosyVoice çš„ Python ä¾èµ–
RUN uv pip install --system --no-cache \
    diffusers \
    lightning \
    rich \
    matplotlib \
    gdown \
    hydra-colorlog \
    hydra-optuna-sweeper \
    rootutils \
    phonemizer \
    pytest \
    tensorboard \
    Cython \
    wandb \
    wget \
    torchcodec \
    --index-url https://mirrors.aliyun.com/pypi/simple/

# å¤åˆ¶é¡¹ç›®ä»£ç 
COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]