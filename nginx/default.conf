# ============================================
# Gzip 压缩配置
# ============================================
gzip on;                      # 启用 gzip 压缩
gzip_vary on;                 # 添加 Vary: Accept-Encoding 响应头
gzip_proxied any;             # 对所有代理请求启用压缩
gzip_comp_level 6;            # 压缩级别 (1-9)，6 是速度和压缩率的平衡点
gzip_buffers 16 8k;           # 设置压缩缓冲区
gzip_http_version 1.1;        # 启用 HTTP/1.1 压缩
gzip_min_length 256;          # 只压缩大于 256 字节的文件

# 需要压缩的 MIME 类型
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    text/csv
    application/json
    application/javascript
    application/x-javascript
    application/xml
    application/xml+rss
    application/rss+xml
    application/atom+xml
    application/xhtml+xml
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-font-opentype
    application/x-font-truetype
    font/eot
    font/opentype
    font/otf
    font/truetype
    image/svg+xml
    image/x-icon;

# 禁用 IE6 的 gzip（IE6 对 gzip 支持有问题）
gzip_disable "msie6";

# HTTP 服务器配置
server {
    listen 80;
    server_name localhost;

    # 客户端最大请求体大小（用于文件上传）
    client_max_body_size 100M;
    
    # 日志配置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # SSE 流式接口 (语音处理进度) - 必须放在最前面
    location ~ ^/api/voice/progress/ {
        proxy_pass http://backend:8080;
        proxy_http_version 1.1;
        
        # SSE 关键配置
        proxy_set_header Connection '';
        proxy_set_header Cache-Control 'no-cache';
        proxy_set_header X-Accel-Buffering 'no';
        
        # 禁用缓冲，实现真正的流式传输
        proxy_buffering off;
        proxy_cache off;
        
        # 重要：SSE 必须禁用 gzip
        gzip off;
        
        # 超时设置（SSE 可能持续很长时间）
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        
        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 后端 API 服务    
    location /api/ {
        proxy_pass http://backend:8080;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }


    # AI Agent 服务

    location /ai/ {
        rewrite ^/ai/(.*) /$1 break;
        proxy_pass http://ai_agent:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


    # MinIO 控制台

    location /minio/ {
        proxy_pass http://minio:9001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # MinIO 控制台需要 WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # MinIO API
    location /minio-api/ {
        rewrite ^/minio-api/(.*) /$1 break;
        proxy_pass http://minio:9000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端静态文件 (代理到 frontend 容器的 nginx)

    location / {
        proxy_pass http://frontend:80;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 支持前端路由
        proxy_intercept_errors on;
        error_page 404 = @frontend;
    }

    location @frontend {
        proxy_pass http://frontend:80;
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}